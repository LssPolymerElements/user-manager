<dom-module id="authenticated-person-behavior">
    <script type="text/javascript">
        AuthenticatedPersonBehavior = Polymer.dedupingMixin(superClass => {
            /* @polymerMixin */
            class AuthenticatedPersonBehavior extends superClass {
                static get properties() {
                    return {
                        personId: {
                            type: Number,
                            notify: true,
                            value: 0
                        },
                        fullname: {
                            type: String,
                            notify: true
                        },
                        firstName: {
                            type: String,
                            notify: true
                        },
                        lastName: {
                            type: String,
                            notify: true
                        }
                    }
                }
                async ready() {
                    super.ready();
                    window.addEventListener('um-person-updated', (e) => {
                        this.setProperties({
                            personId: e.detail.personId,
                            fullname: e.detail.fullname,
                            firstName: e.detail.firstName,
                            lastName: e.detail.lastName
                        });
                        this.personId = e.detail.personId;
                        this.fullname = e.detail.fullname;
                        this.firstName = e.detail.firstName;
                        this.lastName = e.detail.lastName;
                    });
                    try {
                        let person = await this._getPersonAsync();
                        this.setProperties({
                            personId: person.personId,
                            fullname: person.fullname,
                            firstName: person.firstName,
                            lastName: person.lastName
                        });
                    } catch (e) {}
                }
                _getPersonAsync() {
                    return new Promise((resolve, reject) => {
                        var handleUpdate = function listener(e) {
                            window.removeEventListener('um-person', handleUpdate);
                            if (e.detail.rejected) {
                                console.log('rejected token in behavior.');
                                reject(e.detail.message);
                            }
                            console.log('got token in behavior.');
                            resolve(e.detail);
                        }
                        console.log('requesting person...');
                        window.addEventListener('um-person', handleUpdate);
                        window.dispatchEvent(new CustomEvent('um-request-person'));
                    });
                }
            }
            return AuthenticatedPersonBehavior;
        });
    </script>
</dom-module>