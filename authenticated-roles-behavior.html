<dom-module id="authenticated-roles-behavior">
    <script type="text/javascript">
        AuthenticatedRolesBehavior = Polymer.dedupingMixin(superClass => {
            /* @polymerMixin */
            class AuthenticatedRolesBehavior extends superClass {
                static get properties() {
                    return {
                        roles: {
                            type: Array,
                            notify: true,
                            value: []
                        }
                    }
                }
                async ready() {
                    super.ready();
                    window.addEventListener('um-role-added', (e) => {
                        this.push('roles', e.detail.role);
                    });

                    window.addEventListener('um-role-removed', (e) => {
                        var index = this.roles.indexOf(e.detail.role);
                        if (index !== -1) {
                            this.splice('roles', index, 1);
                        }
                    });

                    try {
                        this.roles = await this._getRolesAsync();
                    } catch (e) {}
                }
                _getRolesAsync() {
                    return new Promise((resolve, reject) => {
                        var handleUpdate = function listener(e) {
                            window.removeEventListener('um-roles', handleUpdate);
                            if (e.detail.rejected) {
                                reject(e.detail.message);
                            }
                            resolve(e.detail.roles);
                        }
                        window.addEventListener('um-roles', handleUpdate);
                        console.log('requesting roles...');
                        window.dispatchEvent(new CustomEvent('um-request-roles'));
                    });
                }
            }
            return AuthenticatedRolesBehavior;
        });
    </script>
</dom-module>